Sub CentrairPlazaDX3()
    ' エラーハンドリング
    On Error GoTo ErrorHandler

    ' 定义变量
    Dim nrow As Long, i As Long, wb1 As Workbook, wb2 As Workbook
    Dim sw_1 As Worksheet, sw_2 As Worksheet, sw_generalLeadTime As Worksheet, sw_ROYLeadTime As Worksheet
    Dim brandName As String, productCode As String
    Dim orderDate As Date, deliveryDate As Date
    Dim orderQuantity As Integer, colIndex As Integer
    Dim weekdayColumn As Integer, deliveryDays As Variant
    Dim lastRow As Long, found As Boolean
    Dim foundRow As Range

    ' 获取用户选择的文件路径
    Dim filePath As Variant
    filePath = Application.GetOpenFilename("Excel ファイル (*.xlsm), *.xlsm")

    ' 检查用户是否选择了文件
    If filePath = False Then
        MsgBox "処理がキャンセルされました。", vbInformation
        Exit Sub
    End If

    ' 设置工作簿和工作表
    Set wb1 = Workbooks.Open(filePath)
    Set wb2 = ThisWorkbook
    Set sw_1 = wb1.Sheets("食品全体（原紙）")
    Set sw_2 = wb2.Sheets("納品確認リスト")
    Set sw_generalLeadTime = wb1.Sheets("一般リードタイム")
    Set sw_ROYLeadTime = wb1.Sheets("ROYリードタイム")
    orderDate = sw_1.Range("T2").Value

    ' 计算星期列
    weekdayColumn = WorksheetFunction.Weekday(orderDate, 1) + 4  ' 周日在E列，索引为5
    overwriteAll = False
    asked = False

    ' 处理每一行数据
    For nrow = 5 To sw_1.Range("B" & Rows.Count).End(xlUp).Row
        ' 如果行被隐藏，则跳过此行
        If sw_1.Rows(nrow).Hidden Then
            Debug.Print "Skipping hidden row: " & nrow
            GoTo NextIteration
        End If

        ' 读取行数据
        brandName = sw_1.Range("A" & nrow).Value
        productCode = sw_1.Range("B" & nrow).Value
        orderQuantity = sw_1.Range("S" & nrow).Value

        ' 检查品牌并计算交货天数
        deliveryDays = "×"
        If brandName = "ROY" Then
            Set foundROYCell = sw_ROYLeadTime.Range("B:B").Find(orderDate, LookIn:=xlValues, LookAt:=xlWhole)
            If Not foundROYCell Is Nothing Then
                deliveryDays = foundROYCell.Offset(0, 2).Value
            End If
        Else
    Set foundGeneralCell = sw_generalLeadTime.Columns(1).Find(brandName, LookIn:=xlValues, LookAt:=xlWhole)
    If Not foundGeneralCell Is Nothing Then
        deliveryDays = sw_generalLeadTime.Cells(foundGeneralCell.Row, weekdayColumn).Value
    Else
        deliveryDays = "×"
    End If
End If
' 添加即时调试窗口输出
        Debug.Print "Row " & nrow & ": Brand " & brandName & ", ProductCode " & productCode & _
                    ", OrderQuantity " & orderQuantity & ", DeliveryDays " & deliveryDays
        ' 如果交货天数不是 '×'，则继续处理
        If deliveryDays <> "×" Then
            ' 计算交货日期
            If deliveryDays = 0 Then
                deliveryDate = orderDate
            Else
                deliveryDate = orderDate + deliveryDays
            End If

            ' 在納品確認リスト中查找匹配的商品代码和更新数量
            Dim matchRow As Long
            matchRow = 0
            For i = 3 To sw_2.Range("B" & Rows.Count).End(xlUp).Row
                If sw_2.Cells(i, "B").Value = productCode Then
                    matchRow = i
                    Exit For
                End If
            Next i

            ' 查找对应的交货日期列
            colIndex = 0
            For i = 2 To sw_2.Cells(1, Columns.Count).End(xlToLeft).Column
                If sw_2.Cells(1, i).Value = deliveryDate Then
                    colIndex = i
                    Exit For
                End If
            Next i

            ' 更新商品数量
            If matchRow > 0 And colIndex > 0 Then
                If Not IsEmpty(sw_2.Cells(matchRow, colIndex).Value) And Not asked Then
                    Dim response As VbMsgBoxResult
                    Dim cellAddress As String
                    cellAddress = sw_2.Cells(matchRow, colIndex).Address(False, False)
                    response = MsgBox("セル " & cellAddress & " には既に値が存在します。すべて上書きしますか？", vbYesNo + vbQuestion, "確認")
                    asked = True
                    If response = vbYes Then
                        overwriteAll = True
                    Else
                        MsgBox "上書きを取消しました", vbInformation
                        Exit For
                    End If
                End If
                If overwriteAll Or IsEmpty(sw_2.Cells(matchRow, colIndex).Value) Then
                    sw_2.Cells(matchRow, colIndex).Value = IIf(orderQuantity = 0, "", orderQuantity)
                End If
            End If
        End If

NextIteration:
    Next nrow

    ' 完成处理，显示消息框
    If Not overwriteAll Then
        MsgBox "Congratulations!発注数を納品リストに反映しましたよ。", vbInformation
    End If

    ' 激活納品確認リスト并选择第一行
    sw_2.Activate
    sw_2.Range("A3").Select

    Exit Sub

ErrorHandler:
    ' 发生错误时显示错误消息
    MsgBox "エラーが発生しました: " & Err.Description, vbCritical
    Exit Sub
End Sub



